---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getSourcesSummary, getSourceStatusMap } from "../lib/news";

const sources = getSourcesSummary();
const statusMap = getSourceStatusMap();
const baseUrl = import.meta.env.BASE_URL;
const normalizedBaseUrl = baseUrl.endsWith("/") ? baseUrl : `${baseUrl}/`;
const withBase = (path) => `${normalizedBaseUrl}${String(path ?? "").replace(/^\/+/, "")}`;
---
<BaseLayout title="Sources" description="Browse official sources">
  <section class="glass-panel rounded-3xl px-4 py-4 shadow-soft sm:px-6 sm:py-6">
    <div>
      <h2 class="text-xl font-semibold text-ink-950 sm:text-2xl">Sources</h2>
    </div>
    {sources.length === 0 ? (
      <div class="mt-8 rounded-2xl border border-dashed border-ink-900/20 px-6 py-12 text-center text-sm text-ink-900/60">
        No source data yet.
      </div>
    ) : (
      <div class="mt-6 grid gap-3 md:grid-cols-2">
        {sources.map((source) => {
          const status = statusMap[source.id];
          const statusParts = [];
          if (status?.status) {
            statusParts.push(`Status: ${status.status}`);
          }
          if (status?.last_run) {
            statusParts.push(`Last run ${status.last_run}`);
          }
          const statusLine = statusParts.join(" Â· ");
          return (
          <a
            href={withBase(`source/${source.id}/`)}
            class="flex items-center justify-between rounded-2xl border border-ink-900/10 bg-white/70 px-4 py-3 text-[13px] text-ink-900/80 shadow-soft transition hover:-translate-y-1 hover:border-ink-900/30 sm:px-5 sm:text-sm"
          >
            <div class="min-w-0">
              <div class="truncate font-medium text-ink-950">{source.name}</div>
              {statusLine && (
                <div class="mt-1 text-xs text-ink-900/60 line-clamp-2 sm:mt-2">
                  {statusLine}
                </div>
              )}
            </div>
            <span class="shrink-0 rounded-full bg-ink-900/10 px-3 py-1 text-[11px] text-ink-900/60 sm:text-xs">
              {source.count}
            </span>
          </a>
          );
        })}
      </div>
    )}
  </section>
</BaseLayout>
